<?php
    echo <<<_END
<html>
   <body>
   <header>
        <h1>CS 174 Midterm 2 Mitch Avery</h1>
        <h2>Antivirus Malware Detection</h2>
        <h3>Admin Login (Admin login allows submission of malware file)</h3>
    </header>
    <div class = "container">
        <form action="" method="POST" enctype="multipart/form-data" >
                User Name: <input type="text" name="user" placeholder="Please enter user name" /> <br><br>
                Password: <input type="password" name="password" placeholder="Please enter password" /> <br><br>
                <input type="submit" value='Login'/>
        </form>
        <p>If logging in as a new admin user click here: <a href="newuser.php">New Admin User</a></p>
        <p>If not an admin, looking to verify a file, click here: <a href="verifyfile.php">Verify File</a></p>
      </div>
   </body>
</html>
_END;

function executeFile() {
    require_once('login.php');
    $connection = new mysqli($hn, $un, $pw, $db);
    if ($connection->connect_error) die($connection->connect_error);

    if (isset($_SERVER['PHP_AUTH_USER']) && isset($_SERVER['PHP_AUTH_PW']))
	{
	    $un_temp = mysql_entities_fix_string($connection, $_SERVER['PHP_AUTH_USER']);
	    $pw_temp = mysql_entities_fix_string($connection, $_SERVER['PHP_AUTH_PW']);
	    $query = "SELECT * FROM users_test WHERE username='$un_temp'";
	    $result = $connection->query($query);
        if (!$result) die($connection->error);
		elseif ($result->num_rows) 
		{
			$row = $result->fetch_array(MYSQLI_NUM);
			$result->close();
			$salt1 = get_salt1($connection);
			$salt2 = get_salt2($connection);
			$token = hash('ripemd128', "$salt1$pw_temp$salt2");

			if ($token == $row[3]) {
                echo "$row[0] $row[1] : Hi $row[0], you are now logged in as '$row[2]'";
            }
			else die("Invalid username/password combination");
		}
		else die("Invalid username/password combination");
    }
    else { 	
        header('WWW-Authenticate: Basic realm="Restricted Section"');
		header('HTTP/1.0 401 Unauthorized');
		die ("Please enter your username and password");
	}
    
    if (isset($_POST['user']) && isset($_POST['password']))
    {
        $user = get_post($connection, 'user');
        $password = get_post($connection, 'password');
        $query = "SELECT * FROM users_test WHERE username='$user'";
	    $result = $connection->query($query);
        if (!$result) die($connection->error);
		elseif ($result->num_rows) 
		{
			$row = $result->fetch_array(MYSQLI_NUM);
			$result->close();
			$salt1 = get_salt1($connection);
			$salt2 = get_salt2($connection);
			$token = hash('ripemd128', "$salt1$password$salt2");
			if ($token == $row[3]) {
                echo "$row[0] $row[1] : Hi! $row[0], you are now logged in as '$row[2]'";
                header('location:uploadmalware.php');
            }
			else die("Invalid username/password combination");
		}
		else die("Invalid username/password combination");
    }
    else {
        echo "Must submit both values";
    }
    $connection->close();
}

function get_salt1($conn) {
    $query = "SELECT salt1 FROM salts";
    $result = $conn->query($query);
    if (!$result) die($conn->error);
    $rows = $result->num_rows;
    $salt1;
    for ($j=0; $j<$rows; ++$j)
    {
        $result->data_seek($j);
        $row = $result->fetch_array(MYSQLI_ASSOC);
        $salt1 = $row['salt1'];
    }
    return $salt1;
}

function get_salt2($conn) {
    $query = "SELECT salt2 FROM salts";
    $result = $conn->query($query);
    if (!$result) die($conn->error);
    $rows = $result->num_rows;
    $salt2;
    for ($j=0; $j<$rows; ++$j)
    {
        $result->data_seek($j);
        $row = $result->fetch_array(MYSQLI_ASSOC);
        $salt2 = $row['salt2'];
    }
    return $salt2;
}


function mysql_fix_string($conn, $string) 
{
    if (get_magic_quotes_gpc()) $string = stripslashes($string);
    return ($conn->real_escape_string($string));
}

function mysql_entities_fix_string($conn, $string)
{
	return htmlentities(mysql_fix_string($conn, $string));
}
function get_post($conn, $var)
{
	return ($conn->real_escape_string($_POST[$var]));
}

executeFile();

?>