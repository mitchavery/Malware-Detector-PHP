<?php
    echo <<<_END
<html>
   <body>
   <header>
        <a href="midterm2.php">Home</a>
        <h2>Creating a new admin user</h2>
    </header>
        <form action="" method="POST" enctype="multipart/form-data" >
                First Name: <input type="text" name="firstname" placeholder="Please enter user first name" /> <br><br>
                Last Name: <input type="text" name="lastname" placeholder="Please enter user last name" /> <br><br>
                User Name: <input type="text" name="user" placeholder="Please enter user name" /> <br><br>
                Password: <input type="password" name="password" placeholder="Please enter password" /> <br><br>
                <input type="submit" value='Create New User'/>
        </form>
    <p>To return to login page, click here: <a href="midterm2.php">login</a></p>
   </body>
</html>
_END;

function executeFile() {
    require_once('login.php');
    $conn = new mysqli($hn, $un, $pw, $db);
    if ($conn->connect_error) die($conn->connect_error);
    $salt1 = get_salt1($conn);
    $salt2 = get_salt2($conn);
    if (isset($_POST['user']) && isset($_POST['password']) && isset($_POST['firstname']) && isset($_POST['lastname']))
    {
        $user = get_post($conn, 'user');
        $password = get_post($conn, 'password');
        $firstname = get_post($conn, 'firstname');
        $lastname = get_post($conn, 'lastname');
        $token = hash('ripemd128', "$salt1$password$salt2");
        $result = add_user($conn, $firstname, $lastname, $user, $token, $password);
    }
    else {
        echo "Must submit all values";
    }
    $conn->close();
}

function get_salt1($conn) {
    $query = "SELECT salt1 FROM salts";
    $result = $conn->query($query);
    if (!$result) die($conn->error);
    $rows = $result->num_rows;
    $salt1;
    for ($j=0; $j<$rows; ++$j)
    {
        $result->data_seek($j);
        $row = $result->fetch_array(MYSQLI_ASSOC);
        $salt1 = $row['salt1'];
    }
    $result->close();
    return $salt1;
}

function get_salt2($conn) {
    $query = "SELECT salt2 FROM salts";
    $result = $conn->query($query);
    if (!$result) die($conn->error);
    $rows = $result->num_rows;
    $salt2;
    for ($j=0; $j<$rows; ++$j)
    {
        $result->data_seek($j);
        $row = $result->fetch_array(MYSQLI_ASSOC);
        $salt2 = $row['salt2'];
    }
    $result->close();
    return $salt2;
}

function add_user($connection, $fn, $sn, $un, $pw, $realpassowrd) 
{
    $query = "INSERT INTO users_test VALUES('$fn', '$sn', '$un', '$pw')";
    $result = $connection->query($query);
    if (!$result) die($connection->error);
    else echo "User created successfully<br><br>Username: " . $un . "<br>Password: " . $realpassowrd;
    return $result;
}

function get_post($conn, $var)
{
	return ($conn->real_escape_string($_POST[$var]));
}

executeFile();

?>